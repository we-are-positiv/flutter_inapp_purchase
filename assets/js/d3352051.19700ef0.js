"use strict";(self.webpackChunkflutter_inapp_purchase_docs=self.webpackChunkflutter_inapp_purchase_docs||[]).push([[7384],{368:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>o,contentTitle:()=>c,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"guides/ios-purchase-state-detection","title":"iOS Purchase State Detection","description":"Overview","source":"@site/docs/guides/ios-purchase-state-detection.md","sourceDirName":"guides","slug":"/guides/ios-purchase-state-detection","permalink":"/docs/guides/ios-purchase-state-detection","draft":false,"unlisted":false,"editUrl":"https://github.com/hyochan/flutter_inapp_purchase/tree/main/docs/docs/guides/ios-purchase-state-detection.md","tags":[],"version":"current","frontMatter":{}}');var t=n(4848),a=n(8453);const r={},c="iOS Purchase State Detection",o={},l=[{value:"Overview",id:"overview",level:2},{value:"Common iOS Purchase Issues",id:"common-ios-purchase-issues",level:2},{value:"1. Processing State Stuck Issue",id:"1-processing-state-stuck-issue",level:3},{value:"2. Timeout Errors",id:"2-timeout-errors",level:3},{value:"Implementation Best Practices",id:"implementation-best-practices",level:2},{value:"1. Comprehensive Purchase State Detection",id:"1-comprehensive-purchase-state-detection",level:3},{value:"2. Timeout Error Handling",id:"2-timeout-error-handling",level:3},{value:"3. Duplicate Transaction Prevention",id:"3-duplicate-transaction-prevention",level:3},{value:"Debugging iOS Purchase Issues",id:"debugging-ios-purchase-issues",level:2},{value:"1. Enable Detailed Logging",id:"1-enable-detailed-logging",level:3},{value:"2. Test on Real Device",id:"2-test-on-real-device",level:3},{value:"3. Check StoreKit Configuration",id:"3-check-storekit-configuration",level:3},{value:"Troubleshooting Checklist",id:"troubleshooting-checklist",level:2},{value:"For Processing State Issues:",id:"for-processing-state-issues",level:3},{value:"For Timeout Issues:",id:"for-timeout-issues",level:3},{value:"For Double Purchase Issues:",id:"for-double-purchase-issues",level:3},{value:"Related Issues",id:"related-issues",level:2},{value:"See Also",id:"see-also",level:2}];function d(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",input:"input",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"ios-purchase-state-detection",children:"iOS Purchase State Detection"})}),"\n",(0,t.jsx)(s.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(s.p,{children:"iOS purchase state detection can be complex due to the differences in how iOS App Store handles purchase confirmations compared to Android Google Play Store. This guide explains the common issues and solutions for proper iOS purchase state detection in flutter_inapp_purchase."}),"\n",(0,t.jsx)(s.h2,{id:"common-ios-purchase-issues",children:"Common iOS Purchase Issues"}),"\n",(0,t.jsx)(s.h3,{id:"1-processing-state-stuck-issue",children:"1. Processing State Stuck Issue"}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Problem"}),': iOS purchases succeed (valid tokens and transaction IDs are generated) but the UI remains stuck in "Processing..." state.']}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Root Cause"}),": The ",(0,t.jsx)(s.code,{children:"transactionStateIOS"})," field often returns ",(0,t.jsx)(s.code,{children:"null"})," even for successful purchases, while ",(0,t.jsx)(s.code,{children:"purchaseToken"})," and ",(0,t.jsx)(s.code,{children:"transactionId"})," contain valid data."]}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Solution"}),": Use multiple conditions to detect successful purchases:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-dart",children:"bool isPurchased = false;\n\nif (Platform.isIOS) {\n  bool condition1 = purchase.transactionStateIOS == TransactionState.purchased;\n  bool condition2 = purchase.purchaseToken != null && purchase.purchaseToken!.isNotEmpty;\n  bool condition3 = purchase.transactionId != null && purchase.transactionId!.isNotEmpty;\n\n  // For iOS, receiving a purchase update usually means success\n  // especially if we have either a valid token OR transaction ID\n  isPurchased = condition1 || condition2 || condition3;\n}\n"})}),"\n",(0,t.jsx)(s.h3,{id:"2-timeout-errors",children:"2. Timeout Errors"}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Problem"}),': iOS purchases fail with timeout errors ("\uc694\uccad\ud55c \uc2dc\uac04\uc774 \ucd08\uacfc\ub418\uc5c8\uc2b5\ub2c8\ub2e4").']}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Root Cause"}),": Apple App Store server issues or network connectivity problems."]}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Solutions"}),":"]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"Wait a few minutes and retry"}),"\n",(0,t.jsx)(s.li,{children:"Check network connection (try switching between WiFi and cellular)"}),"\n",(0,t.jsx)(s.li,{children:"Test on real device instead of simulator"}),"\n",(0,t.jsx)(s.li,{children:"Restart the app or device"}),"\n",(0,t.jsx)(s.li,{children:"Check Apple system status"}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"implementation-best-practices",children:"Implementation Best Practices"}),"\n",(0,t.jsx)(s.h3,{id:"1-comprehensive-purchase-state-detection",children:"1. Comprehensive Purchase State Detection"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-dart",children:"Future<void> _handlePurchaseUpdate(Purchase purchase) async {\n  print('\ud83c\udfaf Purchase update received: ${purchase.productId}');\n  print('  Platform: ${purchase.platform}');\n  print('  Transaction state iOS: ${purchase.transactionStateIOS}');\n  print('  Purchase token: ${purchase.purchaseToken}');\n  print('  Transaction ID: ${purchase.transactionId}');\n\n  bool isPurchased = false;\n\n  if (Platform.isIOS) {\n    // Enhanced iOS detection logic\n    bool hasValidState = purchase.transactionStateIOS == TransactionState.purchased;\n    bool hasValidToken = purchase.purchaseToken != null && purchase.purchaseToken!.isNotEmpty;\n    bool hasValidTransactionId = purchase.transactionId != null && purchase.transactionId!.isNotEmpty;\n\n    isPurchased = hasValidState || hasValidToken || hasValidTransactionId;\n    \n    print('  iOS condition checks:');\n    print('    transactionStateIOS == purchased: $hasValidState');\n    print('    has valid purchaseToken: $hasValidToken');\n    print('    has valid transactionId: $hasValidTransactionId');\n    print('  Final isPurchased: $isPurchased');\n  }\n\n  if (isPurchased) {\n    // Handle successful purchase\n    setState(() {\n      _isProcessing = false;\n      _purchaseResult = '\u2705 Purchase successful: ${purchase.productId}';\n    });\n\n    // Finish the transaction\n    await _iap.finishTransaction(purchase);\n  }\n}\n"})}),"\n",(0,t.jsx)(s.h3,{id:"2-timeout-error-handling",children:"2. Timeout Error Handling"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-dart",children:"void _handlePurchaseError(PurchaseError error) {\n  if (error.message.contains('\uc694\uccad\ud55c \uc2dc\uac04\uc774 \ucd08\uacfc\ub418\uc5c8\uc2b5\ub2c8\ub2e4') || \n      error.message.contains('timeout') ||\n      error.message.contains('timed out')) {\n    // Handle timeout specifically\n    setState(() {\n      _purchaseResult = '''\n\u23f1\ufe0f Request Timeout\nCode: ${error.code}\nMessage: ${error.message}\n\n\ud83d\udd04 Suggested Actions:\n1. Check your internet connection\n2. Wait a few minutes and try again\n3. Restart the app\n4. Try on a different network (WiFi/Cellular)\n5. Restart your device\n6. Check Apple server status\n\nThis is usually a temporary server issue.\n      ''';\n    });\n  }\n}\n"})}),"\n",(0,t.jsx)(s.h3,{id:"3-duplicate-transaction-prevention",children:"3. Duplicate Transaction Prevention"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-dart",children:"class _PurchaseScreenState extends State<PurchaseScreen> {\n  final Set<String> _processedTransactionIds = {};\n\n  Future<void> _handlePurchaseUpdate(Purchase purchase) async {\n    // Check for duplicate processing\n    final transactionId = purchase.transactionId ?? purchase.purchaseToken ?? '';\n    if (transactionId.isNotEmpty && _processedTransactionIds.contains(transactionId)) {\n      print('\u26a0\ufe0f Transaction already processed: $transactionId');\n      return;\n    }\n\n    // Process purchase...\n    \n    // Mark as processed\n    if (transactionId.isNotEmpty) {\n      _processedTransactionIds.add(transactionId);\n    }\n  }\n}\n"})}),"\n",(0,t.jsx)(s.h2,{id:"debugging-ios-purchase-issues",children:"Debugging iOS Purchase Issues"}),"\n",(0,t.jsx)(s.h3,{id:"1-enable-detailed-logging",children:"1. Enable Detailed Logging"}),"\n",(0,t.jsx)(s.p,{children:"Add comprehensive logging to understand what's happening:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-dart",children:"print('\ud83c\udfaf Purchase updated: ${purchase.productId}');\nprint('  Platform: ${purchase.platform}');\nprint('  Purchase state: ${purchase.purchaseState}');\nprint('  Transaction state iOS: ${purchase.transactionStateIOS}');\nprint('  Transaction ID: ${purchase.transactionId}');\nprint('  Purchase token: ${purchase.purchaseToken}');\nprint('  Purchase token length: ${purchase.purchaseToken?.length ?? 0}');\n"})}),"\n",(0,t.jsx)(s.h3,{id:"2-test-on-real-device",children:"2. Test on Real Device"}),"\n",(0,t.jsx)(s.p,{children:"iOS Simulator can have different behavior than real devices. Always test critical purchase flows on physical iOS devices."}),"\n",(0,t.jsx)(s.h3,{id:"3-check-storekit-configuration",children:"3. Check StoreKit Configuration"}),"\n",(0,t.jsx)(s.p,{children:"Ensure your StoreKit configuration file (if using StoreKit testing) has the correct product IDs and is properly configured."}),"\n",(0,t.jsx)(s.h2,{id:"troubleshooting-checklist",children:"Troubleshooting Checklist"}),"\n",(0,t.jsx)(s.h3,{id:"for-processing-state-issues",children:"For Processing State Issues:"}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Verify purchase update listener is properly set up"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Check if ",(0,t.jsx)(s.code,{children:"purchaseToken"})," or ",(0,t.jsx)(s.code,{children:"transactionId"})," are present even when ",(0,t.jsx)(s.code,{children:"transactionStateIOS"})," is null"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Ensure UI state is updated in the purchase listener"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Verify transaction is being finished with ",(0,t.jsx)(s.code,{children:"finishTransaction()"})]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"for-timeout-issues",children:"For Timeout Issues:"}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Test on different network connections"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Try on real device vs simulator"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Check Apple system status"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Verify product IDs are correct"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Ensure App Store Connect configuration is complete"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"for-double-purchase-issues",children:"For Double Purchase Issues:"}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Implement transaction ID tracking"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Check for duplicate listeners"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Verify ",(0,t.jsx)(s.code,{children:"finishTransaction()"})," is called properly"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Add proper error handling"]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"related-issues",children:"Related Issues"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://github.com/hyochan/flutter_inapp_purchase/issues/XXX",children:"iOS purchases stuck in Processing state"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://github.com/hyochan/flutter_inapp_purchase/issues/XXX",children:"Apple timeout errors"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://github.com/hyochan/flutter_inapp_purchase/issues/XXX",children:"Transaction state detection improvements"})}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"see-also",children:"See Also"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"/docs/examples/basic-store",children:"Purchase Flow Implementation"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"/docs/guides/error-handling",children:"Error Handling Guide"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"/docs/guides/troubleshooting",children:"Troubleshooting Guide"})}),"\n"]})]})}function u(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>r,x:()=>c});var i=n(6540);const t={},a=i.createContext(t);function r(e){const s=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),i.createElement(a.Provider,{value:s},e.children)}}}]);